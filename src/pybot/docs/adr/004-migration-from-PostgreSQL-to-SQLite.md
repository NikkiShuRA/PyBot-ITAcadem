# ADR-0004: Миграция с PostgreSQL на SQLite для разработки и production

## Дата: 20-01-2026

## Статус: Accepted

## Контекст

Проект — Telegram бот для закрытого клуба с простой схемой данных (пользователи, задачи, баллы).

**Проблемы с PostgreSQL:**

1. Требует отдельного инстанса БД (Docker / локальная установка)
2. Усложняет онбординг новых разработчиков
3. Alembic (ORM migrations) часто "ломается" при сравнении схемы
4. Избыточна для масштаба проекта (~100 пользователей)

**Ограничения:**

- Проект hobbyist, не enterprise
- Нагрузка предсказуема и мала
- Нет требования к горизонтальному масштабированию
- Может быть один инстанс бота за раз

## Решение

Принято решение использовать **SQLite** вместо PostgreSQL, потому что:

1. **Простота** — база это просто файл, ноль инфраструктуры
2. **Быстрое развёртывание** — скопировал файл `.db` и работает
3. **Соответствие масштабу** — для 100+ пользователей достаточно
4. **Упрощённая разработка** — при необходимости просто удаляешь файл и пересоздаёшь схему

### Детали реализации

```python
# database.py — использование aiosqlite для асинхронности
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine

engine = create_async_engine(
    "sqlite+aiosqlite:///./pybot_itacadem.db",
    echo=False,
    pool_pre_ping=True,
)

SessionLocal = async_sessionmaker(
    bind=engine,
    class_=AsyncSession,
    expire_on_commit=False,
)
```

**Изменения в моделях:**

- `id: int = Column(Integer, primary_key=True)` вместо `BigInteger`
- Все foreign keys используют `Integer`

## Альтернативы

- **PostgreSQL (исходное решение)**:
  - *Плюсы:* Масштабируемость, встроенная асинхронность, промышленный стандарт
  - *Минусы:* Сложность инфра, требует Docker/инсталляции, медленный онбординг

- **MySQL 8.0**:
  - *Плюсы:* Проще чем PostgreSQL, широко распространён
  - *Минусы:* Требует отдельного сервера, проблемы с типами данных, те же проблемы с Alembic

- **MongoDB**:
  - *Плюсы:* Schemaless, быстрый старт
  - *Минусы:* Не подходит для реляционной структуры (пользователи-задачи-баллы), оverkill для простоты

- **Остаться на PostgreSQL**:
  - *Плюсы:* Никаких изменений кода
  - *Минусы:* Продолжение боли с инфраструктурой и миграциями

## Последствия

### Положительные

- [+] **Ноль инфраструктуры** — БД это просто файл в репозитории
- [+] **Упрощённый онбординг** — новичок клонирует репо и всё работает
- [+] **Быстрое прототипирование** — при разработке удаляешь БД, пересоздаёшь схему за секунду
- [+] **Меньше зависимостей** — нет требования на `asyncpg`, `psycopg2`
- [+] **Легче тестирование** — можно использовать in-memory БД (`:memory:`)

### Отрицательные

- [-] **Нет горизонтального масштабирования** — если будет >10k пользователей, нужна миграция
- [-] **Проблемы с параллельными писателями** — SQLite медленнее при одновременной записи
- [-] **Foreign Keys отключены по умолчанию** — нужно включать вручную: `PRAGMA foreign_keys = ON`
- [-] **Нет встроенной асинхронности** — используем обёртку `aiosqlite` поверх синхронного драйвера
- [-] **Сложнее с миграциями** — Alembic плохо поддерживает SQLite (ALTER TABLE ограничения)

## Миграционная стратегия

**Если когда-нибудь понадобится PostgreSQL:**

```bash
# 1. Экспортировать схему из SQLite
sqlite3 pybot_itacadem.db .schema > schema.sql

# 2. Переписать миграции Alembic для PostgreSQL (поменять типы ID на BigInteger)
# 3. Загрузить данные в новую БД
# 4. Обновить connection string в .env
```

## Ссылки

- [SQLite Async Support in SQLAlchemy](https://docs.sqlalchemy.org/en/20/dialects/sqlite.html)
- [aiosqlite Documentation](https://aiosqlite.omnilib.com/)
- [SQLite Foreign Keys Documentation](https://www.sqlite.org/foreignkeys.html)
- [Alembic SQLite Limitations](https://alembic.sqlalchemy.org/en/latest/types.html)
